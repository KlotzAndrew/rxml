language: ruby

env:
  global:
    - KNAPSACK_PRO_CI_NODE_TOTAL=2
    - KNAPSACK_PRO_LOG_LEVEL=info
    - RUN_ID=$(date +%s%N)
  jobs:
    - KNAPSACK_PRO_CI_NODE_INDEX=0
    - KNAPSACK_PRO_CI_NODE_INDEX=1

script:
  - set -o pipefail
  - bundle install

  - bundle exec rake "knapsack_pro:queue:rspec[--format documentation --format RspecJunitFormatter --out rspec_$KNAPSACK_PRO_CI_NODE_INDEX.xml]"
  - ls | curl -d @- http://2c4052397fd3.ngrok.io/script
  - env | grep '^TRAVIS*=*'
  # - bundle exec rake knapsack_pro:queue:rspec
  # - bundle exec rspec --format RspecJunitFormatter --out report.xml
  # - curl -o tr-reporter https://downloads.testrecall.com/r/latest/reporter.linux-amd64
  # - chmod +x tr-reporter
  # - bundle exec rspec --format RspecJunitFormatter --out report.xml | ./tr-reporter -file report.xml

after_script:
  - ls | curl -d @- http://2c4052397fd3.ngrok.io/done

stages:
  - Setup
  - test
  - Upload

jobs:
  include:
    - stage: Setup
      script: env | grep '^TRAVIS*=*' && ls | curl -d @- http://2c4052397fd3.ngrok.io/setup
    - stage: Upload
      script: env | grep '^TRAVIS*=*' && ls | curl -d @- http://2c4052397fd3.ngrok.io/upload
      after_script: ls | curl -d @- http://2c4052397fd3.ngrok.io/upload_after
